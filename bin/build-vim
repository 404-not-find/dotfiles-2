#!/bin/bash

dir='/data/repo/vim'
prefix="${HOME}/local/vim"
flags="--prefix=${prefix} --without-x --enable-darwin --disable-selinux --disable-xsmp --disable-xsmp-interact --enable-pythoninterp=yes --enable-rubyinterp=yes --enable-cscope --disable-workshop --disable-netbeans --disable-smack --disable-sniff --disable-hangulinput --enable-fontset --enable-largefile --disable-acl --disable-gpm --disable-sysmouse --with-features=huge --with-compiledby=mhi"

version() {
    version=$(vim --version | head -1 | cut -d' ' -f5)
    patchlevel=$(vim --version | head -3 | tail -1 | cut -d'-' -f2)
    full="${version}.${patchlevel}"
}

cd "$dir"
echo '[*] Cleaning directory..'
make distclean 1>/dev/null

if [[ $1 == '-f' ]]; then
    echo '[!] Force building..'
else
    echo '[*] Pulling changes..'
    if git pull | grep 'Already up-to-date.' &>/dev/null; then
        echo '[!] No changes found.'
        version
        echo "[*] Current version: $full"
        exit 1
    fi
fi

echo "[*] Build log: ${dir}/build.log"
echo '[*] Configure..'
./configure $flags >build.log
echo '[*] Compile sources..'
make >>build.log
echo '[*] Install..'
make install >>build.log
version
echo "[*] New version: $full"
